#!/bin/bash
#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#  ðŸ¤– SIMONS AI - Master Control Script
#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
#  ANVÃ„NDNING (lÃ¤tt att minnas!):
#
#    ./simons-ai status   â† Kolla om allt kÃ¶r
#    ./simons-ai start    â† Starta allt
#    ./simons-ai stop     â† Stoppa allt
#    ./simons-ai restart  â† Omstart
#    ./simons-ai logs     â† Se vad som hÃ¤nder
#    ./simons-ai warmup   â† Ladda Qwen i VRAM
#
#â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'
BOLD='\033[1m'

PROJECT_DIR="/home/ai-server/01_PROJECTS/01_AI-VIBE-WORLD"

print_header() {
    echo ""
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BOLD}  ðŸ¤– SIMONS AI - $1${NC}"
    echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
}

show_help() {
    print_header "HJÃ„LP"
    echo -e "  ${GREEN}./simons-ai status${NC}   - Visa status fÃ¶r alla tjÃ¤nster"
    echo -e "  ${GREEN}./simons-ai start${NC}    - Starta backend + frontend"
    echo -e "  ${GREEN}./simons-ai stop${NC}     - Stoppa allt"
    echo -e "  ${GREEN}./simons-ai restart${NC}  - Starta om allt"
    echo -e "  ${GREEN}./simons-ai logs${NC}     - Visa live-loggar"
    echo -e "  ${GREEN}./simons-ai warmup${NC}   - Ladda Qwen i GPU VRAM"
    echo -e "  ${GREEN}./simons-ai rebuild${NC}  - Bygg om frontend + restart"
    echo ""
}

do_status() {
    print_header "STATUS"

    if systemctl is-active --quiet simons-ai-backend; then
        echo -e "  ${GREEN}âœ… Backend${NC}   - RUNNING"
    else
        echo -e "  ${RED}âŒ Backend${NC}   - STOPPED"
    fi

    if systemctl is-active --quiet simons-ai-frontend; then
        echo -e "  ${GREEN}âœ… Frontend${NC}  - RUNNING"
    else
        echo -e "  ${RED}âŒ Frontend${NC}  - STOPPED"
    fi

    if systemctl is-active --quiet ollama; then
        echo -e "  ${GREEN}âœ… Ollama${NC}    - RUNNING"
    else
        echo -e "  ${RED}âŒ Ollama${NC}    - STOPPED"
    fi

    echo ""
    echo -e "${BOLD}  ðŸ“Š GPU & MODELLER:${NC}"
    ollama ps 2>/dev/null || echo "     (ingen modell laddad)"

    echo ""
    echo -e "${BOLD}  ðŸŒ ADRESSER:${NC}"
    echo "     Frontend: http://192.168.86.32:5173"
    echo "     Backend:  http://192.168.86.32:8000"
    echo ""
}

do_start() {
    print_header "STARTAR"
    echo -e "  ${YELLOW}â–¶${NC} Ollama..."
    sudo systemctl start ollama && sleep 2
    echo -e "  ${YELLOW}â–¶${NC} Backend..."
    sudo systemctl start simons-ai-backend && sleep 2
    echo -e "  ${YELLOW}â–¶${NC} Frontend..."
    sudo systemctl start simons-ai-frontend && sleep 2
    echo -e "  ${YELLOW}â–¶${NC} Warmup Qwen..."
    $PROJECT_DIR/scripts/warmup-qwen.sh > /dev/null 2>&1 &
    echo -e "\n  ${GREEN}âœ… ALLT STARTAT!${NC}\n"
    do_status
}

do_stop() {
    print_header "STOPPAR"
    echo -e "  ${YELLOW}â– ${NC} Frontend..."
    sudo systemctl stop simons-ai-frontend
    echo -e "  ${YELLOW}â– ${NC} Backend..."
    sudo systemctl stop simons-ai-backend
    echo -e "\n  ${GREEN}âœ… STOPPAT${NC} (Ollama kÃ¶rs kvar)\n"
}

do_restart() {
    print_header "OMSTART"
    do_stop
    sleep 2
    do_start
}

do_logs() {
    print_header "LOGGAR (Ctrl+C = avsluta)"
    journalctl -u simons-ai-backend -u simons-ai-frontend -f --no-pager
}

do_warmup() {
    print_header "WARMUP"
    $PROJECT_DIR/scripts/warmup-qwen.sh
    echo ""
    ollama ps
    echo ""
}

do_rebuild() {
    print_header "REBUILD FRONTEND"
    cd $PROJECT_DIR/frontend
    npm run build
    echo -e "\n  ${YELLOW}â–¶${NC} Restartar tjÃ¤nster..."
    sudo systemctl restart simons-ai-frontend
    sudo systemctl restart simons-ai-backend
    echo -e "  ${GREEN}âœ… KLART!${NC}\n"
}

case "${1}" in
    status|s)   do_status ;;
    start)      do_start ;;
    stop)       do_stop ;;
    restart|r)  do_restart ;;
    logs|l)     do_logs ;;
    warmup|w)   do_warmup ;;
    rebuild)    do_rebuild ;;
    *)          show_help ;;
esac
